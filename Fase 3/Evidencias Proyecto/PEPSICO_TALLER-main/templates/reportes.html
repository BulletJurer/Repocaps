{% extends "base.html" %}
{% load static %}
{% load roles %}

{% block title %}Reportes | Taller PepsiCo Chile{% endblock %}

{% block content %}
<div class="page-container fade-in">

  <!-- ============================
       Acceso Denegado
  ============================= -->
  {% if acceso_denegado %}
  <div class="alert alert-danger mt-4">
    ğŸš« <strong>Acceso denegado.</strong> Solo el <strong>Supervisor</strong> puede ver esta secciÃ³n.
  </div>
  {% endif %}

  {% if not acceso_denegado %}

  <!-- ============================
       ENCABEZADO
  ============================= -->
  <div class="welcome-card mb-4">
    <div class="welcome-content">
      <div class="welcome-avatar">ğŸ“Š</div>
      <div class="welcome-text">
        <h1>Panel de Reportes</h1>
        <p>EstadÃ­sticas en tiempo real â€” Taller PepsiCo Chile</p>
      </div>
    </div>
  </div>

  <!-- ============================
       KPIs Globales
  ============================= -->
  <div class="stats-section mb-4" id="kpiContainer">
    <div class="stats-card">
      <div class="stat-number" id="kpi_vehiculos_totales">â€”</div>
      <div class="stat-label">VehÃ­culos Totales</div>
    </div>

    <div class="stats-card">
      <div class="stat-number" id="kpi_vehiculos_taller">â€”</div>
      <div class="stat-label">En Taller</div>
    </div>

    <div class="stats-card">
      <div class="stat-number" id="kpi_ordenes_activas">â€”</div>
      <div class="stat-label">OTs Activas</div>
    </div>

    <div class="stats-card">
      <div class="stat-number" id="kpi_empleados">â€”</div>
      <div class="stat-label">Empleados Activos</div>
    </div>
  </div>

  <!-- ============================
       GrÃ¡fico 1 â€” VehÃ­culos por Taller
  ============================= -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">ğŸš— VehÃ­culos por Recinto</h5>
      <canvas id="chartVehiculosTaller" height="120"></canvas>
    </div>
  </div>

  <!-- ============================
       GrÃ¡fico 2 â€” OTs por Taller (pend/proceso/fin)
  ============================= -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">ğŸ› ï¸ Ã“rdenes de Trabajo por Recinto</h5>
      <canvas id="chartOTsTaller" height="120"></canvas>
    </div>
  </div>

  <!-- ============================
       GrÃ¡fico 3 â€” Tiempos Promedio
  ============================= -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">â±ï¸ Tiempos Promedio de ReparaciÃ³n</h5>
      <canvas id="chartTiempos" height="120"></canvas>
    </div>
  </div>

  {% endif %}
</div>

{% if not acceso_denegado %}
<!-- ============================
     Chart.js
============================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ============================
     Script del Dashboard
============================= -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("ğŸ“Š Cargando reportes...");

  loadKPIs();
  loadTalleres();
  loadTiempos();

  // ====================================================
  // 1) KPIs Globales
  // ====================================================
  async function loadKPIs() {
    try {
      const res = await fetch("/reportes/api/resumen/", {
        credentials: "same-origin"
      });
      const data = await res.json();

      if (!res.ok || !data.success) {
        console.warn("Error KPIs:", data.message || res.status);
        return;
      }

      const d = data.data || {};
      const elVehTot = document.getElementById("kpi_vehiculos_totales");
      const elVehTal = document.getElementById("kpi_vehiculos_taller");
      const elOTAct  = document.getElementById("kpi_ordenes_activas");
      const elEmp    = document.getElementById("kpi_empleados");

      if (elVehTot) elVehTot.textContent = d.vehiculos_totales ?? "0";
      if (elVehTal) elVehTal.textContent = d.vehiculos_en_taller ?? "0";
      if (elOTAct)  elOTAct.textContent  = d.ordenes_activas ?? "0";
      if (elEmp)    elEmp.textContent    = d.empleados_activos ?? "0";

    } catch (e) {
      console.error("Error KPIs", e);
    }
  }

  // ====================================================
  // 2) VehÃ­culos + OTs por Taller
  // ====================================================
  async function loadTalleres() {
    try {
      const res = await fetch("/reportes/api/talleres/", {
        credentials: "same-origin"
      });
      const data = await res.json();
      if (!res.ok || !data.success) {
        console.warn("Error talleres:", data.message || res.status);
        return;
      }

      const items = Array.isArray(data.items) ? data.items : [];

      const labels    = items.map(t => t.nombre);
      const vehiculos = items.map(t => t.vehiculos_total);
      const otsPend   = items.map(t => t.ots_pendientes);
      const otsProc   = items.map(t => t.ots_en_proceso);
      const otsFin    = items.map(t => t.ots_finalizadas);

      const ctxVeh = document.getElementById("chartVehiculosTaller");
      const ctxOTs = document.getElementById("chartOTsTaller");

      if (ctxVeh) {
        new Chart(ctxVeh, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [{
              label: "VehÃ­culos",
              data: vehiculos,
              backgroundColor: "#007bff88",
              borderColor: "#007bff",
              borderWidth: 1
            }]
          }
        });
      }

      if (ctxOTs) {
        new Chart(ctxOTs, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Pendiente",
                data: otsPend,
                backgroundColor: "#ffc107aa",
                borderColor: "#ffc107",
                borderWidth: 1
              },
              {
                label: "En Proceso",
                data: otsProc,
                backgroundColor: "#17a2b8aa",
                borderColor: "#17a2b8",
                borderWidth: 1
              },
              {
                label: "Finalizado",
                data: otsFin,
                backgroundColor: "#28a745aa",
                borderColor: "#28a745",
                borderWidth: 1
              }
            ]
          }
        });
      }

    } catch (e) {
      console.error("Error talleres", e);
    }
  }

  // ====================================================
  // 3) Tiempos Promedio
  // ====================================================
  async function loadTiempos() {
    try {
      const res = await fetch("/reportes/api/tiempos/", {
        credentials: "same-origin"
      });
      const data = await res.json();
      if (!res.ok || !data.success) {
        console.warn("Error tiempos:", data.message || res.status);
        return;
      }

      const porTaller = data.por_taller || {};
      const items = Object.values(porTaller);

      const labels  = items.map(t => t.taller);
      const valores = items.map(t => t.promedio_dias || 0);

      const ctx = document.getElementById("chartTiempos");
      if (!ctx) return;

      new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "Promedio (dÃ­as)",
            data: valores,
            tension: 0.3,
            borderColor: "#6610f2",
            backgroundColor: "#6610f244",
            borderWidth: 2,
            fill: true
          }]
        }
      });

    } catch (e) {
      console.error("Error tiempos", e);
    }
  }

});
</script>
{% endif %}

{% endblock %}
