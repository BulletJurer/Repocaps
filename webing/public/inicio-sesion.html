<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login - Gesti√≥n de Veh√≠culos PepsiCo Chile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    /* ------------------- ESTILOS ------------------- */
    body {
      background: linear-gradient(135deg, #004b93 0%, #002d62 100%);
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .login-container {
      background: white;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 400px;
    }
    .loading-spinner { display: none; }
    .alert { display: none; }
    .logo { text-align: center; margin-bottom: 1.5rem; }
    .logo h2 { color: #004b93; font-weight: bold; }
    .btn-primary { background-color: #004b93; border-color: #004b93; }
    .btn-primary:hover { background-color: #003366; border-color: #003366; }
    #envIndicator { text-align: center; font-size: 0.8rem; margin-top: 0.5rem; color: #666; }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="logo">
      <h2>üöó Taller PepsiCo</h2>
      <p class="text-muted">Sistema de Gesti√≥n de Veh√≠culos</p>
    </div>

    <!-- Alertas -->
    <div class="alert alert-danger" id="errorAlert" role="alert"><i class="fas fa-exclamation-triangle"></i> <span id="errorMessage"></span></div>
    <div class="alert alert-success" id="successAlert" role="alert"><i class="fas fa-check-circle"></i> <span id="successMessage"></span></div>

    <!-- FORMULARIO -->
    <form id="loginForm">
      <div class="mb-3">
        <label for="usuario" class="form-label"><i class="fas fa-user"></i> Usuario</label>
        <input type="text" class="form-control" id="usuario" placeholder="Ingresa tu usuario" maxlength="30" required />
      </div>

      <div class="mb-3">
        <label for="contrasena" class="form-label"><i class="fas fa-lock"></i> Contrase√±a</label>
        <input type="password" class="form-control" id="contrasena" placeholder="Ingresa tu contrase√±a" maxlength="30" required />
      </div>

      <div class="d-grid">
        <button type="submit" class="btn btn-primary mb-3" id="loginButton">
          <span class="spinner-border spinner-border-sm loading-spinner" id="loadingSpinner"></span>
          <span id="buttonText">üîê Ingresar al Sistema</span>
        </button>
      </div>

      <div class="text-center">
        <a href="#" class="text-decoration-none text-muted"><small>¬øOlvidaste tu contrase√±a?</small></a>
      </div>

      <div id="envIndicator"></div>
    </form>
  </div>

  <!-- ------------------- SCRIPTS ------------------- -->
  <script type="module">
    // Importamos funciones del api.js
    import { login, getStatus, API_BASE_URL } from './js/api.js';

    const loginForm = document.getElementById("loginForm");
    const loginButton = document.getElementById("loginButton");
    const loadingSpinner = document.getElementById("loadingSpinner");
    const buttonText = document.getElementById("buttonText");
    const errorAlert = document.getElementById("errorAlert");
    const errorMessage = document.getElementById("errorMessage");
    const successAlert = document.getElementById("successAlert");
    const successMessage = document.getElementById("successMessage");
    const envIndicator = document.getElementById("envIndicator");

    // Mostrar el entorno activo
    envIndicator.innerHTML = window.location.hostname.includes("localhost") ? "üåê Entorno local activo" : "üöÄ Conectado al t√∫nel remoto";

    // Funciones de UI
    function showError(msg) { errorMessage.textContent = msg; errorAlert.style.display="block"; successAlert.style.display="none"; }
    function showSuccess(msg) { successMessage.textContent = msg; successAlert.style.display="block"; errorAlert.style.display="none"; }
    function hideAlerts() { errorAlert.style.display="none"; successAlert.style.display="none"; }
    function setLoading(isLoading) {
      loadingSpinner.style.display = isLoading ? "inline-block" : "none";
      buttonText.textContent = isLoading ? " Verificando..." : "üîê Ingresar al Sistema";
      loginButton.disabled = isLoading;
    }

    // ------------------- EVENTO SUBMIT ------------------- //
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      hideAlerts();
      const usuario = document.getElementById("usuario").value;
      const contrasena = document.getElementById("contrasena").value;

      if (!usuario || !contrasena) { showError("Por favor complete todos los campos"); return; }

      setLoading(true);

      try {
        const data = await login(usuario, contrasena); // Llamada a api.js
        if (data.success) {
          const empleadoData = data.empleado;
          localStorage.setItem("usuario", JSON.stringify(empleadoData));
          localStorage.setItem("token", "authenticated");
          showSuccess(`‚úÖ Bienvenido ${empleadoData.nombre}`);
          setTimeout(() => window.location.replace("inicio.html"), 1500);
        } else {
          showError(data.message || "Usuario o contrase√±a incorrectos");
        }
      } catch (err) {
        showError(err.message || "Error de conexi√≥n con el servidor");
      } finally { setLoading(false); }
    });

  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
